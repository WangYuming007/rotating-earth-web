# Plan v4.0 - Solar Lighting, High-Resolution Terrain & Geo-Realism

> Status: Superseded by `PLAN.v4.1-earth-system.md` (wind/current realism first).

## 文档定位
- 本文档是 **v4.0 拟真地球升级计划**，目标是把当前展示型地球升级为“可放大查看细节、带真实地形与丰富地理信息”的版本。
- 与历史计划分区：
  - `PLAN.md`：v1.0 功能建设
  - `PLAN.v2-debug.md`：v2.0 稳定性修复
  - `PLAN.v3-atmosphere.md`：v3.0 大气光晕美化
  - `PLAN.v4-geo-realism.md`：v4.0 太阳光照 + 高分辨率 + 地形与地理信息

## 1. v4.0 核心目标
1. 太阳光照模拟真实化
- 支持按真实时间驱动太阳方向（含地轴倾角与季节变化）。
- 白天/黄昏/夜晚过渡自然，夜景灯光与云层高光联动。

2. 分辨率与可放大细节升级
- 支持从全球视角到近距离放大观察。
- 纹理与地形采用多级细节（LOD），避免“一放大就糊”。

3. 地形高低与地理信息增强
- 地表具有可感知的高程起伏（山脉/高原/海沟等）。
- 可叠加丰富地理信息图层，支持开关与样式控制。

## 2. 功能范围（MVP v4）
### A. 太阳光照系统
- 基于 UTC 时间计算太阳方向。
- 地轴倾角（约 23.4°）参与日照计算。
- 统一驱动：地表光照、夜景灯光遮罩、大气散射方向。

### B. 高分辨率地球材质
- 全局底图升级到高分辨率（如 4K/8K 级）。
- 放大时切换高分辨率局部 tile（按视距加载）。
- 法线/粗糙度/镜面参数按区域差异处理。

### C. 地形（DEM）
- 使用高程数据生成位移（displacement）与法线增强。
- 可配置地形夸张系数（默认接近真实，支持轻微增强）。
- 海洋与陆地不同材质响应（高光/粗糙度差异）。

### D. 地理信息图层（可开关）
- 海岸线/国界线/主要河流。
- 地形分区（山脉、高原、盆地）基础标识。
- 主要城市点位（分级显示，随缩放变化）。
- 经纬网（可选）。

## 3. 数据与资源计划
## 3.1 栅格数据
- 日间地表纹理（高分辨率）。
- 夜间灯光纹理（高分辨率）。
- 云层纹理（可选动态序列）。
- 高程 DEM（用于 displacement + normal）。

## 3.2 矢量数据
- 海岸线、国界、河流、主要城市。
- 需要预处理：简化、分级、切片化，控制前端负载。

## 3.3 资源处理流程（离线）
- 原始数据 -> 投影统一 -> 切片（金字塔） -> 压缩 -> 前端按需加载。
- 生成多种质量档位：`ultra / high / medium / low`。

## 4. 渲染架构升级
### Phase A - 光照与时间系统
- 新增 `solar model` 模块：输入日期时间，输出太阳方向。
- 统一 shader uniform：地表、夜景、大气共享太阳方向。
- 支持“实时模式”和“手动拖动时间轴模式”。

### Phase B - LOD 与贴图流式加载
- 建立地球 tile 管理器（视锥 + 距离驱动）。
- 先显示低分辨率底图，再渐进替换高清 tile。
- 配置缓存上限与淘汰策略（避免显存爆炸）。

### Phase C - 地形细节
- 以 DEM 构建地形位移，法线贴图协同增强。
- 远景降低位移强度，近景提升细节。
- 提供“真实模式/展示模式”切换（展示模式可略微夸张地形）。

### Phase D - 地理信息图层
- 矢量图层按缩放级别显示（避免标签堆叠）。
- 样式层级：底图 < 地形阴影 < 国界/海岸线 < 城市标注。
- 支持图层开关与透明度控制。

## 5. 性能与质量预算
- 启动时间目标：首次可交互 <= 5s（先低清可用，后续渐进增强）。
- 帧率目标：
  - 桌面：常规视角 50-60fps
  - 移动：常规视角 >= 30fps
- 显存预算：根据设备能力动态限制同时驻留 tile 数量。
- 降级策略：
  - 关闭部分图层
  - 降低地形位移分辨率
  - 降低纹理质量档位

## 6. 交互与产品体验
- 缩放越近，图层信息越丰富（分级 reveal）。
- 支持“定位到区域/国家”快速跳转（后续可扩展）。
- 提供“信息密度预设”：
  - `Cinematic`（视觉优先）
  - `Balanced`（默认）
  - `Geo-rich`（信息优先）

## 7. 验收标准
- P0：太阳照明方向与时间变化一致，昼夜边界自然。
- P0：放大后细节显著提升，不出现持续模糊。
- P0：地形起伏可见，山脉与高原形态清晰。
- P1：地理图层可开关，显示层级与缩放联动正常。
- P1：本地与线上稳定运行，无长时间 loading 或卡死。

## 8. 风险与应对
1. 数据体积过大
- 应对：离线切片 + 多档压缩 + 按需加载。

2. 前端渲染压力高
- 应对：LOD、帧预算、图层限流、设备分级。

3. 数据版权与许可复杂
- 应对：优先选择可商用/可再分发数据源，并在仓库注明 license。

4. 标签与边界过密影响观感
- 应对：分级显示与碰撞避免策略。

## 9. 实施顺序（建议）
1. 先做太阳光照统一管线（不改数据体积）。
2. 再上高分辨率底图与 LOD。
3. 接着接入 DEM 地形起伏。
4. 最后叠加地理信息图层并做 UI 控制。

## 10. 本轮边界
- 本次仅产出 v4.0 计划文档，不进行代码修改。
- 下一轮从 `Phase A（太阳光照系统）` 开始实现与验证。

# Plan v2.0 - Debug & Fix Plan for "Earth Pulse"

## 文档定位
- 本文档是 **v2.0 Debug 计划**，用于定位并修复当前页面长期停留在 `Loading Earth...` 的问题。
- 与原始规划分区说明：
  - `PLAN.md`：v1.0 产品与实现路线（功能规划）
  - `PLAN.v2-debug.md`：v2.0 问题定位与修复路线（稳定性与可运行性）

## 1. 当前已观察到的现象（2026-02-26）
- 页面框架正常加载（标题、按钮、布局可见）。
- 3D 场景区域长期显示 `Loading Earth...`（超过 60 秒）。
- 用户体感：页面不可用。

## 2. 高概率根因假设（按优先级）
1. ESM 模块导入失败（最高优先）
- 现象特征：脚本早期报错，Three.js 场景逻辑未启动。
- 典型报错：`Failed to resolve module specifier "three"`。

2. 远程纹理资源加载阻塞（高优先）
- 现象特征：脚本启动了，但 `Promise.all` 长时间等待单个或多个贴图。
- 影响：`Loading` 长时间不消失。

3. WebGL/硬件加速能力问题（中优先）
- 现象特征：canvas 创建失败或渲染上下文不可用。
- 影响：无法渲染地球。

4. 运行时异常未被兜底（中优先）
- 现象特征：某个环节 throw 后没有进入用户可见降级路径。

5. 移动端或低性能设备过载（次优先）
- 现象特征：帧率极低、卡死、浏览器主动降级。

## 3. Debug 总体策略（先定位，再精修）
- 原则 1：先确保“能看到地球”（可运行）再做“精美化”。
- 原则 2：每一步都要有可验证输出（Console/Network/页面行为）。
- 原则 3：任何外部依赖（CDN/贴图）都必须有超时与降级策略。

## 4. 分阶段 Debug 计划

### Phase A - 复现与证据采集
目标：确认卡在哪个阶段。

执行项：
1. 本地与线上同时复现（本地静态服务器 + GitHub Pages）。
2. 记录 Console 错误与警告。
3. 记录 Network 请求状态（是否有长期 pending / blocked）。
4. 记录是否创建了 `#scene canvas`。

产出：
- 一份“错误事实表”：报错文本、资源 URL、耗时、失败比例。

### Phase B - 根因归类与优先修复顺序
目标：把问题映射到确定修复动作。

判定矩阵：
1. 如果出现 `module specifier`/导入错误
- 进入 Fix-1（模块导入链重构）

2. 如果模块正常但贴图超时或失败
- 进入 Fix-2（资源加载策略重构）

3. 如果 WebGL 不可用
- 进入 Fix-3（WebGL 检测与降级渲染）

4. 如果无明显错误但仍长期 loading
- 进入 Fix-4（启动状态机与超时兜底）

### Phase C - 按结果实施修复

Fix-1（模块导入链重构）
- 目标：确保浏览器能稳定解析 `three` 与 controls 依赖。
- 方向：统一 ESM 入口策略，避免裸模块在浏览器直跑时无法解析。
- 验收：无模块解析错误，主逻辑执行到渲染循环。

Fix-2（资源加载策略重构）
- 目标：防止任何单资源阻塞全局启动。
- 方向：
  - 单资源超时机制；
  - `Promise.all` 改“可部分成功”；
  - 分级降级（全纹理 -> 基础纹理 -> 纯色球体）。
- 验收：即使纹理失败，10 秒内仍能看到可旋转地球。

Fix-3（WebGL 检测与降级渲染）
- 目标：明确“不能渲染”的用户反馈，不再无限 loading。
- 方向：
  - 启动前检测 WebGL 支持；
  - 不支持时显示替代 UI（静态地球图/说明）。
- 验收：无 WebGL 设备也能看到可理解页面状态。

Fix-4（状态机与可观测性）
- 目标：让每个阶段可见、可诊断。
- 方向：
  - 启动阶段状态：`boot -> module_ready -> assets_ready -> render_ready`；
  - loading 文案细化（例如“加载模块/贴图中/启用降级模式”）；
  - 错误日志具备错误码。
- 验收：任何失败场景都能在 UI 上说明当前状态，不会卡死在单一文案。

### Phase D - 反复验证闭环（重点）
目标：保证“你打开就能看”。

验证循环：
1. 本地验证（至少 3 轮刷新）
- 每轮 cold load 观察首屏时间、地球是否出现、交互是否可用。

2. 线上验证（GitHub Pages，至少 3 轮）
- 清缓存后访问；
- 移动端模拟视口检查；
- 记录最慢一轮时间。

3. 异常注入验证（至少 2 类）
- 模拟贴图失败；
- 模拟慢网；
- 确认降级模式仍出现地球或可用替代。

通过标准（必须全部满足）：
- P0：不会再出现超过 15 秒且无变化的 `Loading Earth...`。
- P0：任一环境最终都能看到“可用画面”（地球或降级替代）。
- P1：正常网络下 10 秒内看到可旋转地球。
- P1：控制台无阻断性错误。

## 5. 修改执行计划（在 Debug 结果之后）
- Commit 1：可观测性与日志（低风险）。
- Commit 2：模块导入链修复（高优先）。
- Commit 3：资源加载与降级机制（关键稳定性）。
- Commit 4：WebGL 检测与兜底 UI。
- Commit 5：性能回收与文案优化。

说明：每个 commit 后都要跑 Phase D 的最小验证子集，再继续下一步。

## 6. 发布与回归策略
- 发布到 `main` 后触发 GitHub Pages 自动部署。
- 部署成功后立即执行线上回归检查。
- 若回归失败：保留可用版本，快速修复后再次发布，避免展示不可用页面。

## 7. 本轮工作边界
- 本次仅制定 v2.0 Debug 计划，不进行代码修改。
- 下一轮按此计划进入 Phase A，先收集证据，再按判定矩阵实施修复。
